<html>
  <head>
    <title>WebRTC demo</title>
    <!--Bootstrap only for styling-->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <!--Bootstrap only for styling-->
  </head>
  <style>
    .container {
      background: rgb(148, 144, 144);
      margin: 50px auto;
      max-width: 80%;
      text-align: center;
      padding: 2%;
    }

    button {
      margin: 1em;
    }

    input {
      margin-top: 1em;
    }
    .arrange-horizontally > * {
      display: inline-block;
      text-align: center;
    }
    .arrange-vertically > * {
      display: block;
    }

    .footer {
      background: rgb(148, 144, 144);
      text-align: center;
      padding: 2%;
      position: absolute;
      bottom: 0;
      width: 100%;
    }

    .u {
      border: 5px outset red;
      background-color: lightblue;
      text-align: center;
    }
  </style>

  <body>
    <div id="videos"></div>

    <!--WebRTC related code-->
    <span id="userName"></span>
    <input
      id="messageInput"
      type="text"
      class="form-control"
      placeholder="message"
    />
    <button type="button" class="btn btn-primary" onclick="createOffer()">
      SEND
    </button>
    <script src="Meet-adapter-final.js"></script>
    <!--WebRTC related code-->

    <script>
      window.onbeforeunload = () => {
        return "are you sure";
      };
      fetch = function () {
        var users = JSON.parse(
          JSON.stringify(Object.entries(MeetJS.activeUsers))
        );
        //console.log("getting users",users);
        var name = document.getElementById("name");
        if (name) name.remove();
        var div = document.createElement("div");
        var ul = document.createElement("ul");
        users.forEach(([k, v]) => {
          var li = document.createElement("li");
          li.innerText = k;
          li.onclick = () => {
            MeetJS.emit("CALL", k);
          };
          ul.appendChild(li);
        });
        ua = div.appendChild(ul);
        div.id = "name";
        div.classList.add("u");
        document.body.append(div);
        setTimeout(() => {
          fetch();
        }, 10 * 1000);
      };

      var meet = new MeetJS({
        contextPath: "socket",
        url: "https://chat-demo-v1.herokuapp.com".replace("http", "ws"),
      });
      window.activeUsers = [];
      meet.on("READY", (e) => {
        console.log("connected.....", e);
        document.getElementById("userName").innerText =
          "Connected as " + meet.userName;
        fetch();
      });
      meet.on("INVITE", (peerName) => {
        meet.emit("ACCEPT", peerName);
        // meet.emit("cancel", peerName);
        // meet.emit("reject", peerName);
      });
      function setlocalVideo(peerName, stream) {
        var local = document.getElementById(peerName);
        if (local) {
          if (
            local.srcObject &&
            local.srcObject.id !== stream.id &&
            !local.srcObject.active
          ) {
            local.srcObject = stream.srcObject;
          } else if (!local.srcObject) {
            local.srcObject = stream;
          }
        } else if (!local) {
          var video = document.createElement("video");
          video.autoplay = true;
          video.muted = true;
          video.width = "320";
          video.height = "240";
          video.id = peerName;
          video.srcObject = stream;
          document.getElementById("videos").appendChild(video);
        }
      }
      function setRemoteVideo(peerName, stream) {
        var video;
        if (!document.getElementById(peerName)) {
          video = document.createElement("video");
          video.autoplay = true;
          video.width = "320";
          video.height = "240";
          video.id = peerName;
          video.srcObject = stream;
          document.getElementById("videos").appendChild(video);
        } else {
          video = document.getElementById(peerName);
          video.srcObject = stream;
        }
      }
      meet.on("CONNECTED", (user) => {
        console.log("call connected with " + user.peerName);
        if (user && user.lStream && user.rStream) {
          setlocalVideo(user.peerName, user.lStream);
          activeUsers[user.remotePeer] = user.remotePeer;
          setRemoteVideo(user.remotePeer, user.rStream);
        }
      });
      meet.on("DISCONNECTED", (remotePeer) => {
        if (activeUsers[remotePeer]) {
          delete activeUsers[remotePeer];
          document
            .getElementById("videos")
            .removeChild(document.getElementById(remotePeer));
        }
      });
      meet.on("RECEIVED_MESSAGE", ({ userName, data }) => {
        console.log("received Message!", data);
        alert(data.message);
      });
      // meet.emit("connect");
      // userName
      meet.emit("CONNECT", prompt("enter the userName"));
      function createOffer() {
        MeetJS.emit("CALL", document.getElementById("messageInput").value);
        // meet.emit("sendMessage", {
        //   remotePeer: document.getElementById("messageInput").value,
        //   data: {
        //     message: "am calling you buddy!",
        //     time: new Date(),
        //   },
        // });
        document.getElementById("messageInput").value = "";
      }
    </script>
  </body>
</html>
